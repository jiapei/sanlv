#encoding: utf-8
require 'rubygems'
require 'nokogiri'
require 'open-uri'
require 'logger'
require 'pp'

class String
    def br_to_new_line
        self.gsub('<br>', "\n")
    end
    def n_to_nil
        self.gsub('\n', "")
    end	
    def strip_tag
        self.gsub(%r[<[^>]*>], '').gsub(/\t|\n|\r/, ' ')
    end
end #String
module SanLv
    class UrlBuilder
        attr_reader :domain, :id
        attr_reader :end_type
        def initialize id
			@domain = %q[http://www.szxdc.net/Products]
            @end_type = '_qc.html'
            @id = id.to_s
        end
		
		def first_page_url
            @domain + @end_type
        end #first_page_url
        
        def build_page_url page
            page = page.to_s
            "#{@domain}#{page}#{@end_type}"
        end #build_page_url      
    end #UrlBuilder
    
	class ContentWorker
        attr_reader :url, :doc, :retry_time
        attr_accessor :page_css, :content_css
        class << self
            def log=(log_file)
                @@log = log_file
            end #log=
            def log
                @@log
            end
        end #class
		
        def initialize url
            @url = url
            define_max_retry_time
            define_page_css
            define_content_css
            get_nokogiri_doc
            exit if @doc.nil?
            log_or_output_info
        end #initialize     
		
        def log_or_output_info
            msg = "processing #{@url}"
            if @@log
                @@log.debug msg
            else
                puts msg
            end #if
        end #log_or_output_info
        def get_nokogiri_doc
            times = 0
			from_encode ="gbk"
			to_encode = "utf-8"

            begin
				html_stream = open(@url).read.strip
				#html_stream.encode!(to_encode, from_encode)
                @doc = Nokogiri::HTML(html_stream)
            rescue
                @@log.error "Can Not Open [#{@url}]" if @@log
                times += 1
                retry if(times < @retry_time)
            end #begin
        end #get_nokogiri_doc
        def define_max_retry_time
            @retry_time = 3
        end #define_max_retry_time
		
        def define_page_css
            @page_css = %q[div.page]
        end
        def define_content_css
            @content_css = %q[li.at.c.h2]
        end #define_content_css
		
        def total_page
            #page = ''
            #doc.css(page_css).each do |p|
            #    m = p.content.match(/，\d+/)[0].match(/\d+/)  
            #    page = m[0] if m                                
            #end #each
            #page.to_i
			38
        end #total_page
		
		def build_lists &blk
			puts "采集列表页"
			lists = []

			@doc.css("table.STYLE1 > tr > td > a").each do |item|
				lists << ["pic", "http://www.rizuan.com/" + item.attr("href")]
			end

			
			if block_given?	
				blk.call(lists)			
			else
				puts lists.length
			end
			
			
		end
		
        def build_content &blk
			puts "采集明细页"
			puts @doc.at_css("title")
			@details = []
			
			@details << @doc.at_css("div.seat").text
			
			rows = @doc.xpath('//div[@class = "rightcc"]/p')
			puts rows.length
			rows.each do |row|
				@details << "\t" + row.text
			end
						
			if block_given?	
				blk.call(@details)
			else
				puts "wooooo"
			end
			


		end #build_content
    end #ContentWorker

    class IoFactory

        attr_reader :file

        def self.init file

            @file = file

            if @file.nil?

                puts 'Can Not Init File To Write'

                exit

            end #if

            File.open @file, 'a'

        end     

    end #IoFactory

    class Runner        

            attr_reader :url_builder, :start_url

            attr_reader :total_page, :file_to_write

            def initialize id

                init_logger

                @url_lists = %w(117110 117101 117102 117103 117105 117109 117106 117100 117107 117111 117112 117113 199104 199103 199101 199100 199105 199106 221103 221102 221101 221100 221104 209103 209102 209100 209104 209107 101101 101100 120125 120101 120103 120121 120104 120123 120105 120122 120119 120120 120124 120118 120106 120140 120117 120139 120108 120126 120100 120128 120110 120129 120130 120111 120131 120112 120132 120133 120134 120136 120138 120127 118112 118116 118115 118113 118118 118111 118109 118108 118117 118105 118100 118119 118120 150103 150100 128101 128100 128102 143104 143101 143100 143102 143103 143105 234100 234101 234102 234103 234104 234105 234106 129103 129102 129101 129104 137105 137108 137101 137102 137103 137109 137104 137107 137110 137111 137112 161100 161101 187105 187104 187103 187102 187101 187100 187106 187107 187108 187109 138100 210105 210104 210103 210102 210101 210100 210106 229100 229101 229104 229102 229103 229105 229106 229107 229108 229109 229110 119103 119102 119101 119104 119100 106105 106100 106104 106101 106106 106107 106108 106109 108106 108100 108101 108102 108103 108104 108105 108108 108107 108109 108110 114113 114112 114111 114110 114109 114108 114107 114105 114104 114103 114102 114101 114100 114114 114115 114116 114117 114118 115100 115104 115103 115102 115101 159102 159101 159100 159103 121101 121102 121111 121100 121117 121112 121113 121114 121115 121109 121116 121118 121119 121120 121121 121122 186105 186104 186103 186102 186101 186100 186106 186107 186108 186109 186110 186111 200105 200104 200103 200102 200101 200100 200106 227100 227101 227102 116100 134100 134101 134102 134103 134104 134105 134107 134108 232100 162101 162102 162100 162103 162104 225100 225101 225102 225103 225104 225105 225106 225107 225108 225109 225110 225111 144100 144101 144102 144103 174100 174111 174112 174113 174114 174117 174119 174120 174121 174122 174123 174124 174125 174126 174127 174128 174129 174130 174131 174133 174135 174136 174137 174138 174139 174140 174141 174142 174143 174144 174145 174146 195100 195101 201100 201101 201102 201103 201104 201105 201106 201107 201108 171103 171101 171100 171102 205104 205105 205103 205102 205101 205100 205106 205107 109100 109101 109103 109104 158100 158101 158102 158103 163108 163107 163104 163102 163105 163100 163111 163112 163109 163110 163113 163115 163116 163117 163118 204104 204103 204101 204100 204105 216101 216100 223100 127100 127101 127102 145104 145103 145102 145101 145100 145105 145106 145107 146103 146101 146100 146104 146102 146105 146106 146107 165100 165102 165101 153104 153103 153102 153101 153100 153106 153107 153108 154101 154100 154102 155100 155107 155106 155105 155104 155103 155102 155101 155108 202104 202103 202102 202101 202100 202105 202106 151100 151106 151105 151104 151103 151102 151101 151107 151108 151109 224109 224108 224105 224107 224104 224100 224111 224110 224112 224101 224103 224106 224113 224114 224115 224116 156101 156108 156102 156100 156103 156109 156104 156106 156107 156105 156110 156111 157106 157105 157100 157103 157104 157107 157108 166104 166103 166102 166101 166100 236100 236101 236102 236103 236104 226100 211104 211103 211101 211100 211105 175106 175100 175107 175102 175103 175104 175105 175108 175109 102101 102100 135100 167102 167101 167100 167103 167104 167105 167106 170104 170103 170102 170101 170100 170105 188100 107102 107101 107100 111100 111103 111102 111101 176101 176100 176102 139101 139104 139102 139100 139105 243101 220102 220101 220100 220104 220105 168101 168102 168104 168100 168103 168105 168106 214102 214103 214101 214100 214104 214105 212100 212101 160103 160102 160101 160100 160104 173101 173100 173102 213101 213100 207102 207101 207100 112101 112100 112102 177102 177101 177103 177100 177104 177105 203101 203100 203102 203103 203104 203105 203106 203107 203108 190100 190102 190101 190103 208103 208102 208101 208100 208104 215100 215101 228100 228101 228102 123105 123104 123103 123102 123101 123100 123106 178103 178101 178100 231100 133101 133106 133104 133102 133100 133103 133105 133107 133108 133109 147105 147104 147103 147102 147101 147100 147106 147107 147108 147109 147110 147111 172101 172102 172103 172104 172110 172112 172109 172100 172105 172106 172107 172111 172108 172113 172114 172116 172117 172118 172119 172120 130101 130109 130102 130100 130103 130108 130104 130105 130106 130107 130110 179107 179101 179103 179102 179100 179106 179104 179105 179108 179109 179110 218107 218106 218105 218104 218103 218102 218101 218100 218108 218109 218110 191101 191100 191102 191103 233100 233101 180101 180102 180103 180104 180106 180105 180100 180107 180108 136103 136104 136100 136106 136107 124102 124101 124100 124103 185102 185100 185103 181101 181104 181102 181100 181103 181105 181106 183101 183100 230100 192101 192102 192103 192104 192100 192105 194100 194102 194101 194103 194104 238100 238101 238102 238103 238104 113101 113100 184101 184102 184105 184100 184106 126100 126106 126101 126102 126103 126104 126105 125101 125100 193100 193101 193102 193103 193104 193105 193106 193107 193108 193109 242100 104100 104105 104104 104103 104102 104101 104106 104107 104108 104109 104110 104111 148110 148109 148108 148107 148106 148105 148104 148103 148102 148101 148100 148111 148112 148113 148114 148115 169100 169101 169102 169103 169104 169105 189104 189103 189102 189101 189100 189105 132107 132100 132106 132105 132104 132103 132102 132101 132108 140101 140102 140105 140103 140100 140104 197101 197100 197100 197103 197104 197105 198103 198102 182101 182100 182103 182102 182104 222101 222100 222102 222103 196103 196100 196105 196104 196106 235100 235101 235102 235103 217102 217101 217100 217103 219102 219101 219100 219103 219104 219105 152102 152101 152100 152103 152104)
                
				create_file_to_write id             

                output_content

            end #initialize

            def self.go(id)
                self.new(id)
            end

            def create_file_to_write id
                file_path = File.join('.', id.to_s.concat('.txt'))
                @file_to_write = IoFactory.init(file_path)
            end #create_file_to_write

            def init_logger
                logger_file = IoFactory.init('./log.txt')
                logger = Logger.new logger_file
                ContentWorker.log = logger
            end #init_logger


            def output_content              
				@url_lists.each do |url|
                    list_url = "http://www.beimai.com/SearchHypeNumPartType.aspx?h=#{url}&p=39"
					puts "content_page: #{list_url}" 
                    ContentWorker.new(list_url).build_content do |cc|
								@file_to_write.puts cc
								#@file_to_write.puts '*' * 40
							end # build_content					
						
                end #for each


  

            end #output_content

    end #Runner

end #SanLv

include SanLv

id = 10000

Runner.go id
 